<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ShizuTube</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #results img { width: 160px; border-radius: 6px; }
  .item { cursor: pointer; margin-bottom: 12px; display: flex; gap: 10px; }
  .channel-btn {
    margin-top: 4px;
    font-size: 12px;
    cursor: pointer;
    color: #3366ff;
    text-decoration: underline;
  }
</style>
</head>
<body>

<center>
<img src="https://files.catbox.moe/s9dfwf.png" width="100px">

<input id="search" placeholder="Search ShizuTube…" style="width: 300px;">
<button onclick="doSearch()">Search</button>

<hr>

<iframe
  id="player"
  width="640"
  height="360"
  src=""
  title="ShizuTube video player"
  frameborder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  referrerpolicy="strict-origin-when-cross-origin"
  allowfullscreen>
</iframe>

<hr>
</center>

<div id="results"></div>

<script>
async function doSearch() {
  const q = document.getElementById("search").value.trim();
  if (!q) return;

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Loading…";

  const ytURL = "https://www.youtube.com/results?search_query=" + encodeURIComponent(q);
  const proxyURL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(ytURL);

  let html;
  try {
    html = await fetch(proxyURL).then(r => r.text());
  } catch (e) {
    console.error(e);
    resultsDiv.innerHTML = "Failed to fetch search results.";
    return;
  }

  const ids = [...html.matchAll(/"videoId":"([a-zA-Z0-9_-]{11})"/g)]
    .map(m => m[1])
    .filter((v, i, a) => a.indexOf(v) === i)
    .slice(0, 10);

  if (ids.length === 0) {
    resultsDiv.innerHTML = "No videos found (or parsing failed).";
    return;
  }

  resultsDiv.innerHTML = "<h3>Results</h3>";

  for (const id of ids) {
    let meta;
    try {
      meta = await fetch(
        `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`
      ).then(r => r.json());
    } catch {
      continue;
    }

    // CHANNEL SUPPORT: Extract channel ID from oEmbed author_url
    let channelId = null;
    if (meta.author_url) {
      const channelHTML = await fetch(
        "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(meta.author_url)
      ).then(r => r.text()).catch(() => null);

      if (channelHTML) {
        const match = channelHTML.match(/"channelId":"(UC[0-9A-Za-z_-]+)"/);
        if (match) channelId = match[1];
      }
    }

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="https://i.ytimg.com/vi/${id}/hqdefault.jpg">
      <div>
        <b>${meta.title}</b><br>
        <small>${meta.author_name}</small><br>
        ${channelId ? `<span class="channel-btn" onclick="viewChannel('${channelId}')">View Channel</span>` : ""}
      </div>
    `;

    div.addEventListener("click", () => {
      document.getElementById("player").src =
        "https://www.youtube.com/embed/" + id + "?autoplay=1";
    });

    resultsDiv.appendChild(div);
  }
}

// CHANNEL SUPPORT: Fetch and display channel RSS feed
async function viewChannel(channelId) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Loading channel…";

  const feedURL = "https://www.youtube.com/feeds/videos.xml?channel_id=" + channelId;
  const proxyURL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(feedURL);

  let xmlText;
  try {
    xmlText = await fetch(proxyURL).then(r => r.text());
  } catch {
    resultsDiv.innerHTML = "Failed to load channel feed.";
    return;
  }

  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, "application/xml");
  const entries = [...xml.querySelectorAll("entry")];

  if (entries.length === 0) {
    resultsDiv.innerHTML = "No channel videos found.";
    return;
  }

  const channelName = xml.querySelector("author > name")?.textContent || "Channel";

  resultsDiv.innerHTML = `<h3>${channelName} — Latest Uploads</h3>`;

  for (const entry of entries) {
    const videoId = entry.querySelector("id").textContent.replace("yt:video:", "");
    const title = entry.querySelector("title").textContent;
    const thumb = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${thumb}">
      <div>
        <b>${title}</b><br>
        <small>${channelName}</small>
      </div>
    `;

    div.addEventListener("click", () => {
      document.getElementById("player").src =
        "https://www.youtube.com/embed/" + videoId + "?autoplay=1";
    });

    resultsDiv.appendChild(div);
  }
}
</script>

</body>
</html>
